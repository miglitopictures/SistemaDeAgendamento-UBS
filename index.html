<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Agendamento - UBS</title>
    <style>
        :root {
            --primary: #2E8B6A;
            --secondary: #E8F5E9;
            --danger: #D32F2F;
            --warning: #FFA500;
            --success: #388E3C;
            --text: #212121;
            --light: #F5F5F5;
            --border: #BDBDBD;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
            color: var(--text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px;
            background-color: var(--primary);
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-item button {
            width: 100%;
            padding: 12px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .nav-item button:hover,
        .nav-item button.active {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 22px;
            color: var(--primary);
        }

        .header-subtitle {
            display: block;
            margin-top: 4px;
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
        }

        .logout-btn {
            padding: 10px 20px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background-color: #b71c1c;
        }

        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .card-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }

        /* SECTION */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 20px;
        }

        /* FORMS */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(46, 139, 106, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #1e5f47;
        }

        button.secondary {
            background-color: #757575;
        }

        button.secondary:hover {
            background-color: #616161;
        }

        button.danger {
            background-color: var(--danger);
        }

        button.danger:hover {
            background-color: #b71c1c;
        }

        /* TABLES */
        .table-wrapper {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--secondary);
            color: var(--primary);
            font-weight: 600;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th.sortable {
            cursor: pointer;
        }

        tbody tr:hover {
            background-color: #fafafa;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .edit-btn, .delete-btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .edit-btn {
            background-color: var(--warning);
        }

        .edit-btn:hover {
            background-color: #ff8c00;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #757575;
        }

        .close-modal:hover {
            color: var(--text);
        }

        /* ALERTS */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert-success {
            background-color: #C8E6C9;
            color: #2E7D32;
            border-left: 4px solid var(--success);
        }

        .alert-error {
            background-color: #FFCDD2;
            color: #C62828;
            border-left: 4px solid var(--danger);
        }

        .alert-warning {
            background-color: #FFE0B2;
            color: #E65100;
            border-left: 4px solid var(--warning);
        }

        /* FILTERS */
        .filters {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .filter-group label {
            margin-bottom: 0;
        }

        .filter-group input, .filter-group select {
            margin-bottom: 0;
        }

        /* CHART */
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: #757575;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
        }

        /* FOOTER */
        .footer {
            background-color: #ffffff;
            border-top: 1px solid var(--border);
            padding: 10px 20px;
            font-size: 12px;
            color: #555555;
        }

        .footer .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer p {
            margin: 3px 0;
        }

        .footer .system-info {
            font-style: italic;
            color: #777777;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                display: flex;
                height: auto;
            }

            .nav-menu {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                flex: 1;
            }

            .nav-item {
                margin-bottom: 0;
                flex: 1;
                min-width: 150px;
            }

            .main-content {
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="logo">üè• UBS System</div>
            <ul class="nav-menu">
                <li class="nav-item"><button onclick="showSection('dashboard')" class="active">üìä Dashboard</button></li>
                <li class="nav-item"><button onclick="showSection('pacientes')">üë• Pacientes</button></li>
                <li class="nav-item"><button onclick="showSection('profissionais')">üë®‚Äç‚öïÔ∏è Profissionais</button></li>
                <li class="nav-item"><button onclick="showSection('consultas')">üìÖ Consultas</button></li>
                <li class="nav-item"><button onclick="showSection('relatorios')">üìà Relat√≥rios</button></li>
            </ul>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="header">
                <div>
                    <h1>Sistema de Agendamento UBS - Unidade B√°sica de Sa√∫de</h1>
                    <span class="header-subtitle">ODS 3: Sa√∫de e Bem-Estar</span>
                </div>
                <button class="logout-btn" onclick="logout()">üö™ Sair</button>
            </div>

            <!-- ALERTS -->
            <div id="alertBox" class="alert"></div>

            <!-- DASHBOARD SECTION -->
            <section id="dashboard" class="section active">
                <h2 class="section-title">üìä Dashboard</h2>
                <div class="dashboard-grid" id="dashboardCards">
                    <div class="card">
                        <h3>Pacientes Cadastrados</h3>
                        <div class="card-number" id="totalPacientes">0</div>
                    </div>
                    <div class="card">
                        <h3>Profissionais</h3>
                        <div class="card-number" id="totalProfissionais">0</div>
                    </div>
                    <div class="card">
                        <h3>Consultas Agendadas</h3>
                        <div class="card-number" id="totalConsultas">0</div>
                    </div>
                    <div class="card">
                        <h3>Vacinas Atrasadas</h3>
                        <div class="card-number" id="vacinasAtrasadas">0</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Status de Vacina√ß√£o</h3>
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-label">Em Dia</div>
                            <div class="stat-value" id="vacinasEmDia">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Atrasadas</div>
                            <div class="stat-value" id="vacinasAtrasadasStat">0</div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; color: var(--primary);">Pacientes com Vacinas Atrasadas</h3>
                <div class="table-wrapper" style="margin-top: 15px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Conv√™nio</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="pacientesAtrasadosTable"></tbody>
                    </table>
                </div>
            </section>

            <!-- PACIENTES SECTION -->
            <section id="pacientes" class="section">
                <h2 class="section-title">üë• Pacientes</h2>
                <button onclick="openModalPaciente()">‚ûï Novo Paciente</button>

                <div class="filters" style="margin-top: 15px;">
                    <div class="filter-group">
                        <label>Status Vacinas:</label>
                        <select id="filterVacinas" onchange="loadPacientes()">
                            <option value="">Todos</option>
                            <option value="EM DIA">Em Dia</option>
                            <option value="ATRASADAS">Atrasadas</option>
                        </select>
                    </div>
                </div>

                <div class="table-wrapper" style="margin-top: 15px;">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="ordenarPacientes('nome')">Nome ‚¨ç</th>
                                <th class="sortable" onclick="ordenarPacientes('cpf')">CPF ‚¨ç</th>
                                <th class="sortable" onclick="ordenarPacientes('data_de_nascimento')">Data Nasc. ‚¨ç</th>
                                <th class="sortable" onclick="ordenarPacientes('convenio')">Conv√™nio ‚¨ç</th>
                                <th class="sortable" onclick="ordenarPacientes('vacinas')">Vacinas ‚¨ç</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="pacientesTable"></tbody>
                    </table>
                </div>
            </section>

            <!-- PROFISSIONAIS SECTION -->
            <section id="profissionais" class="section">
                <h2 class="section-title">üë®‚Äç‚öïÔ∏è Profissionais</h2>
                <button onclick="openModalProfissional()">‚ûï Novo Profissional</button>

                <div class="table-wrapper" style="margin-top: 15px;">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="ordenarProfissionais('nome')">Nome ‚¨ç</th>
                                <th class="sortable" onclick="ordenarProfissionais('cpf')">CPF ‚¨ç</th>
                                <th class="sortable" onclick="ordenarProfissionais('crm')">CRM ‚¨ç</th>
                                <th class="sortable" onclick="ordenarProfissionais('rqe')">RQE ‚¨ç</th>
                                <th class="sortable" onclick="ordenarProfissionais('especialidade')">Especialidades ‚¨ç</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="profissionaisTable"></tbody>
                    </table>
                </div>
            </section>

            <!-- CONSULTAS SECTION -->
            <section id="consultas" class="section">
                <h2 class="section-title">üìÖ Consultas</h2>
                <button onclick="openModalConsulta()">‚ûï Nova Consulta</button>

                <div class="filters" style="margin-top: 15px;">
                    <div class="filter-group">
                        <label>Data In√≠cio:</label>
                        <input type="date" id="dataInicio" onchange="loadConsultas()">
                    </div>
                    <div class="filter-group">
                        <label>Data Fim:</label>
                        <input type="date" id="dataFim" onchange="loadConsultas()">
                    </div>
                    <button onclick="loadConsultas()" style="align-self: flex-end;">üîç Filtrar</button>
                </div>

                <div class="table-wrapper" style="margin-top: 15px;">
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable" onclick="ordenarConsultas('id')">ID ‚¨ç</th>
                                <th class="sortable" onclick="ordenarConsultas('data')">Data ‚¨ç</th>
                                <th class="sortable" onclick="ordenarConsultas('horario')">Hor√°rio ‚¨ç</th>
                                <th class="sortable" onclick="ordenarConsultas('paciente')">Paciente ‚¨ç</th>
                                <th class="sortable" onclick="ordenarConsultas('profissional')">Profissional ‚¨ç</th>
                                <th class="sortable" onclick="ordenarConsultas('status')">Status ‚¨ç</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="consultasTable"></tbody>
                    </table>
                </div>
            </section>

            <!-- RELAT√ìRIOS SECTION -->
            <section id="relatorios" class="section">
                <h2 class="section-title">üìà Relat√≥rios</h2>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button onclick="gerarRelatorioProfissional()" style="padding: 20px;">Consultas por Profissional</button>
                    <button onclick="gerarRelatorioConvenio()" style="padding: 20px;">Pacientes por Conv√™nio</button>
                    <button onclick="exportarCSV('pacientes')" style="padding: 20px;">Exportar Pacientes (CSV)</button>
                    <button onclick="exportarCSV('profissionais')" style="padding: 20px;">Exportar Profissionais (CSV)</button>
                    <button onclick="exportarCSV('consultas')" style="padding: 20px;">Exportar Consultas (CSV)</button>
                </div>

                <div id="relatoriosContainer" style="margin-top: 30px;"></div>
            </section>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Sistema de Agendamento de Consultas - UBS | Projeto Final de Fundamentos da Programa√ß√£o</p>
            <p>Desenvolvido para melhorar o fluxo de pacientes e profissionais, alinhado ao ODS 3: Sa√∫de e Bem-Estar</p>
            <p class="system-info">Sistema Online | Backend: Flask | Frontend: HTML/CSS/JS</p>
        </div>
    </footer>

    <!-- MODALS -->
    <div id="modalPaciente" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModalPaciente()">&times;</span>
            <div class="modal-header" id="modalPacienteTitle">Novo Paciente</div>
            <form id="formPaciente" onsubmit="salvarPaciente(event)">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="pacienteNome" required>
                </div>
                <div class="form-group">
                    <label>CPF (XXX.XXX.XXX-XX) *</label>
                    <input type="text" id="pacienteCPF" placeholder="000.000.000-00" required>
                </div>
                <div class="form-group">
                    <label>Data de Nascimento (DD/MM/AAAA) *</label>
                    <input type="text" id="pacienteDataNasc" placeholder="01/01/1990" required>
                </div>
                <div class="form-group">
                    <label>Conv√™nio</label>
                    <input type="text" id="pacienteConvenio">
                </div>
                <div class="form-group">
                    <label>Status Vacinas *</label>
                    <select id="pacienteVacinas" required>
                        <option value="EM DIA">Em Dia</option>
                        <option value="ATRASADAS">Atrasadas</option>
                    </select>
                </div>
                <div class="button-group">
                    <button type="submit">üíæ Salvar</button>
                    <button type="button" class="secondary" onclick="closeModalPaciente()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalProfissional" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModalProfissional()">&times;</span>
            <div class="modal-header" id="modalProfissionalTitle">Novo Profissional</div>
            <form id="formProfissional" onsubmit="salvarProfissional(event)">
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="profissionalNome" required>
                </div>
                <div class="form-group">
                    <label>CPF (XXX.XXX.XXX-XX) *</label>
                    <input type="text" id="profissionalCPF" placeholder="000.000.000-00" required>
                </div>
                <div class="form-group">
                    <label>Data de Nascimento (DD/MM/AAAA)</label>
                    <input type="text" id="profissionalDataNasc" placeholder="01/01/1990">
                </div>
                <div class="form-group">
                    <label>CRM (XXXXXX/UF) *</label>
                    <input type="text" id="profissionalCRM" placeholder="000000/SP" required>
                </div>
                <div class="form-group">
                    <label>RQE (XXXX-XXX) [Opcional]</label>
                    <input type="text" id="profissionalRQE" placeholder="0000-000">
                </div>
                <div class="form-group">
                    <label>Especialidades (separadas por v√≠rgula)</label>
                    <input type="text" id="profissionalEspecialidades" placeholder="Cl√≠nica Geral, Pediatria">
                </div>
                <div class="button-group">
                    <button type="submit">üíæ Salvar</button>
                    <button type="button" class="secondary" onclick="closeModalProfissional()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalConsulta" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModalConsulta()">&times;</span>
            <div class="modal-header" id="modalConsultaTitle">Nova Consulta</div>
            <form id="formConsulta" onsubmit="salvarConsulta(event)">
                <div class="form-group">
                    <label>CPF do Paciente *</label>
                    <input type="text" id="consultaCPFPaciente" placeholder="000.000.000-00" required>
                </div>
                <div class="form-group">
                    <label>CRM do Profissional *</label>
                    <input type="text" id="consultaCRMProfissional" placeholder="000000/UF" required>
                </div>
                <div class="form-group">
                    <label>Data (DD/MM/AAAA) *</label>
                    <input type="text" id="consultaData" placeholder="01/01/2024" required>
                </div>
                <div class="form-group">
                    <label>Hor√°rio (HH:MM) *</label>
                    <input type="text" id="consultaHorario" placeholder="14:30" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="consultaStatus">
                        <option value="AGENDADA">Agendada</option>
                        <option value="CANCELADA">Cancelada</option>
                    </select>
                </div>
                <div class="button-group">
                    <button type="submit">üíæ Salvar</button>
                    <button type="button" class="secondary" onclick="closeModalConsulta()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5000/api';
        let editandoPacienteCPF = null, editandoProfissionalCRM = null, editandoConsultaID = null;
        let pacientesList = [];
        let profissionaisList = [];
        let consultasList = [];
        let ordemPacientes = { coluna: null, asc: true };
        let ordemProfissionais = { coluna: null, asc: true };
        let ordemConsultas = { coluna: null, asc: true };

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            document.querySelectorAll('.nav-item button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (section === 'dashboard') loadDashboard();
            else if (section === 'pacientes') loadPacientes();
            else if (section === 'profissionais') loadProfissionais();
            else if (section === 'consultas') loadConsultas();
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alertBox');
            alert.textContent = message;
            alert.className = `alert ${type === 'error' ? 'alert-error' : 'alert-' + type} active`;
            setTimeout(() => alert.classList.remove('active'), 4000);
        }

        function handleError(error) {
            console.error(error);
            showAlert(error.message || 'Erro na opera√ß√£o', 'error');
        }

        // DASHBOARD
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_URL}/relatorios/dashboard`);
                const data = await res.json();

                if (data.success) {
                    document.getElementById('totalPacientes').textContent = data.data.total_pacientes;
                    document.getElementById('totalProfissionais').textContent = data.data.total_profissionais;
                    document.getElementById('totalConsultas').textContent = data.data.total_consultas_agendadas;
                    document.getElementById('vacinasAtrasadas').textContent = data.data.pacientes_vacinas_atrasadas;
                    document.getElementById('vacinasEmDia').textContent = data.data.pacientes_com_vacinas_em_dia;
                    document.getElementById('vacinasAtrasadasStat').textContent = data.data.pacientes_vacinas_atrasadas;
                    loadPacientesAtrasados();
                }
            } catch (error) {
                handleError(error);
            }
        }

        async function loadPacientesAtrasados() {
            try {
                const res = await fetch(`${API_URL}/relatorios/pacientes-vacinas-atrasadas`);
                const data = await res.json();

                if (data.success) {
                    const tbody = document.getElementById('pacientesAtrasadosTable');
                    tbody.innerHTML = '';
                    data.data.forEach(p => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${p.nome}</td>
                                <td>${p.cpf}</td>
                                <td>${p.convenio}</td>
                                <td><span style="background: var(--warning); color: white; padding: 4px 8px; border-radius: 4px;">‚ö†Ô∏è ATRASADAS</span></td>
                            </tr>
                        `;
                    });
                }
            } catch (error) {
                handleError(error);
            }
        }

        // PACIENTES
        async function loadPacientes() {
            try {
                const filtroVacinas = document.getElementById('filterVacinas').value;
                let url = `${API_URL}/pacientes`;
                if (filtroVacinas) url += `?vacinas=${filtroVacinas}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.success) {
                    pacientesList = data.data;
                    exibirPacientes(pacientesList);
                }
            } catch (error) {
                handleError(error);
            }
        }

        function exibirPacientes(lista) {
            const tbody = document.getElementById('pacientesTable');
            tbody.innerHTML = '';
            lista.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.nome}</td>
                        <td>${p.cpf}</td>
                        <td>${p.data_de_nascimento}</td>
                        <td>${p.convenio}</td>
                        <td><span style="background: ${p.vacinas === 'EM DIA' ? 'var(--success)' : 'var(--danger)'}; color: white; padding: 4px 8px; border-radius: 4px;">${p.vacinas}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="edit-btn" onclick="editarPaciente('${p.cpf}')">‚úèÔ∏è Editar</button>
                                <button class="delete-btn danger" onclick="deletarPaciente('${p.cpf}')">üóëÔ∏è Deletar</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function ordenarPacientes(coluna) {
            if (ordemPacientes.coluna === coluna) {
                ordemPacientes.asc = !ordemPacientes.asc;
            } else {
                ordemPacientes.coluna = coluna;
                ordemPacientes.asc = true;
            }

            const listaOrdenada = [...pacientesList].sort((a, b) => {
                let va = a[coluna] || '';
                let vb = b[coluna] || '';

                if (coluna === 'cpf') {
                    va = va.replace(/\D/g, '');
                    vb = vb.replace(/\D/g, '');
                }

                if (va < vb) return ordemPacientes.asc ? -1 : 1;
                if (va > vb) return ordemPacientes.asc ? 1 : -1;
                return 0;
            });

            exibirPacientes(listaOrdenada);
        }

        function openModalPaciente() {
            editandoPacienteCPF = null;
            document.getElementById('modalPacienteTitle').textContent = 'Novo Paciente';
            document.getElementById('pacienteCPF').disabled = false;
            document.getElementById('formPaciente').reset();
            document.getElementById('modalPaciente').classList.add('active');
        }

        function closeModalPaciente() {
            document.getElementById('modalPaciente').classList.remove('active');
        }

        async function salvarPaciente(e) {
            e.preventDefault();
            const paciente = {
                nome: document.getElementById('pacienteNome').value,
                cpf: document.getElementById('pacienteCPF').value,
                data_de_nascimento: document.getElementById('pacienteDataNasc').value,
                convenio: document.getElementById('pacienteConvenio').value,
                vacinas: document.getElementById('pacienteVacinas').value
            };
            try {
                let res;
                if (editandoPacienteCPF) {
                    res = await fetch(`${API_URL}/pacientes/${editandoPacienteCPF}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(paciente)
                    });
                } else {
                    res = await fetch(`${API_URL}/pacientes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(paciente)
                    });
                }
                const data = await res.json();
                if (data.success) {
                    showAlert(data.message, 'success');
                    closeModalPaciente();
                    loadPacientes();
                    loadDashboard();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                handleError(error);
            }
        }

        async function editarPaciente(cpf) {
            try {
                const res = await fetch(`${API_URL}/pacientes/${cpf}`);
                const data = await res.json();
                if (data.success) {
                    editandoPacienteCPF = cpf;
                    document.getElementById('modalPacienteTitle').textContent = 'Editar Paciente';
                    document.getElementById('pacienteNome').value = data.data.nome;
                    document.getElementById('pacienteCPF').value = data.data.cpf;
                    document.getElementById('pacienteCPF').disabled = true;
                    document.getElementById('pacienteDataNasc').value = data.data.data_de_nascimento;
                    document.getElementById('pacienteConvenio').value = data.data.convenio;
                    document.getElementById('pacienteVacinas').value = data.data.vacinas;
                    document.getElementById('modalPaciente').classList.add('active');
                }
            } catch (error) {
                handleError(error);
            }
        }

        async function deletarPaciente(cpf) {
            if (!confirm('Tem certeza que deseja deletar este paciente?')) return;
            try {
                const res = await fetch(`${API_URL}/pacientes/${cpf}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showAlert('Paciente deletado', 'success');
                    loadPacientes();
                    loadDashboard();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                handleError(error);
            }
        }

        // PROFISSIONAIS
        async function loadProfissionais() {
            try {
                const res = await fetch(`${API_URL}/profissionais`);
                const data = await res.json();
                if (data.success) {
                    profissionaisList = data.data;
                    exibirProfissionais(profissionaisList);
                }
            } catch (error) {
                handleError(error);
            }
        }

        function exibirProfissionais(profissionais) {
            const tbody = document.getElementById('profissionaisTable');
            tbody.innerHTML = '';
            profissionais.forEach((prof, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${prof.nome}</td>
                        <td>${prof.cpf}</td>
                        <td>${prof.crm}</td>
                        <td>${prof.rqe || '‚Äî'}</td>
                        <td>${Array.isArray(prof.especialidade) ? prof.especialidade.join(', ') : '‚Äî'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="edit-btn" onclick="editarProfissional(${index})">‚úèÔ∏è Editar</button>
                                <button class="delete-btn danger" onclick="deletarProfissional(${index})">üóëÔ∏è Deletar</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function ordenarProfissionais(coluna) {
            if (ordemProfissionais.coluna === coluna) {
                ordemProfissionais.asc = !ordemProfissionais.asc;
            } else {
                ordemProfissionais.coluna = coluna;
                ordemProfissionais.asc = true;
            }

            const listaOrdenada = [...profissionaisList].sort((a, b) => {
                let va, vb;
                if (coluna === 'especialidade') {
                    va = Array.isArray(a.especialidade) ? a.especialidade.join(', ') : '';
                    vb = Array.isArray(b.especialidade) ? b.especialidade.join(', ') : '';
                } else {
                    va = a[coluna] || '';
                    vb = b[coluna] || '';
                }

                if (va < vb) return ordemProfissionais.asc ? -1 : 1;
                if (va > vb) return ordemProfissionais.asc ? 1 : -1;
                return 0;
            });

            exibirProfissionais(listaOrdenada);
        }

        function openModalProfissional() {
            editandoProfissionalCRM = null;
            document.getElementById('modalProfissionalTitle').textContent = 'Novo Profissional';
            document.getElementById('profissionalCPF').disabled = false;
            document.getElementById('profissionalCRM').disabled = false;
            document.getElementById('formProfissional').reset();
            document.getElementById('modalProfissional').classList.add('active');
        }

        function closeModalProfissional() {
            document.getElementById('modalProfissional').classList.remove('active');
        }

        async function salvarProfissional(e) {
            e.preventDefault();
            const prof = {
                nome: document.getElementById('profissionalNome').value,
                cpf: document.getElementById('profissionalCPF').value,
                data_de_nascimento: document.getElementById('profissionalDataNasc').value,
                crm: document.getElementById('profissionalCRM').value,
                rqe: document.getElementById('profissionalRQE').value || null,
                especialidade: document.getElementById('profissionalEspecialidades').value
                    .split(',')
                    .map(e => e.trim())
                    .filter(e => e)
            };
            try {
                let res;
                if (editandoProfissionalCRM) {
                    res = await fetch(`${API_URL}/profissional-atualizar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            crm: editandoProfissionalCRM,
                            nome: prof.nome,
                            especialidade: prof.especialidade
                        })
                    });
                } else {
                    res = await fetch(`${API_URL}/profissionais`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(prof)
                    });
                }
                const data = await res.json();
                if (data.success) {
                    showAlert(data.message || 'Profissional salvo com sucesso!', 'success');
                    closeModalProfissional();
                    loadProfissionais();
                    loadDashboard();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                handleError(error);
            }
        }

        async function editarProfissional(index) {
            const prof = profissionaisList[index];
            editandoProfissionalCRM = prof.crm;
            document.getElementById('modalProfissionalTitle').textContent = 'Editar Profissional';
            document.getElementById('profissionalNome').value = prof.nome;
            document.getElementById('profissionalCPF').value = prof.cpf;
            document.getElementById('profissionalCPF').disabled = true;
            document.getElementById('profissionalDataNasc').value = prof.data_de_nascimento || '';
            document.getElementById('profissionalCRM').value = prof.crm;
            document.getElementById('profissionalCRM').disabled = true;
            document.getElementById('profissionalRQE').value = prof.rqe || '';
            document.getElementById('profissionalEspecialidades').value = Array.isArray(prof.especialidade) ? prof.especialidade.join(', ') : '';
            document.getElementById('modalProfissional').classList.add('active');
        }

        async function deletarProfissional(index) {
            if (!confirm('Tem certeza que deseja deletar este profissional?')) return;
            const prof = profissionaisList[index];
            try {
                const res = await fetch(`${API_URL}/profissional-deletar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ crm: prof.crm })
                });
                const data = await res.json();
                if (data.success) {
                    showAlert('Profissional deletado', 'success');
                    loadProfissionais();
                    loadDashboard();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                handleError(error);
            }
        }

        // CONSULTAS
        async function loadConsultas() {
            try {
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                let url = `${API_URL}/consultas`;
                const params = [];
                if (dataInicio) params.push(`data_inicio=${dataInicio}`);
                if (dataFim) params.push(`data_fim=${dataFim}`);
                if (params.length) url += `?${params.join('&')}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.success) {
                    consultasList = data.data;
                    exibirConsultas(consultasList);
                }
            } catch (error) {
                handleError(error);
            }
        }

        function exibirConsultas(lista) {
            const tbody = document.getElementById('consultasTable');
            tbody.innerHTML = '';
            lista.forEach((c, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.data}</td>
                        <td>${c.horario}</td>
                        <td>${c.paciente}</td>
                        <td>${c.profissional}</td>
                        <td><span style="background: ${c.status === 'AGENDADA' ? 'var(--success)' : 'var(--danger)'}; color: white; padding: 4px 8px; border-radius: 4px;">${c.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="edit-btn" onclick="editarConsulta(${index})">‚úèÔ∏è Editar</button>
                                <button class="delete-btn danger" onclick="deletarConsulta(${index})">üóëÔ∏è Deletar</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function ordenarConsultas(coluna) {
            if (ordemConsultas.coluna === coluna) {
                ordemConsultas.asc = !ordemConsultas.asc;
            } else {
                ordemConsultas.coluna = coluna;
                ordemConsultas.asc = true;
            }

            const listaOrdenada = [...consultasList].sort((a, b) => {
                let va = a[coluna];
                let vb = b[coluna];

                if (coluna === 'id') {
                    va = Number(va);
                    vb = Number(vb);
                } else {
                    va = va || '';
                    vb = vb || '';
                }

                if (va < vb) return ordemConsultas.asc ? -1 : 1;
                if (va > vb) return ordemConsultas.asc ? 1 : -1;
                return 0;
            });

            exibirConsultas(listaOrdenada);
        }

        function openModalConsulta() {
            editandoConsultaID = null;
            document.getElementById('modalConsultaTitle').textContent = 'Nova Consulta';
            document.getElementById('formConsulta').reset();
            document.getElementById('modalConsulta').classList.add('active');
        }

        function closeModalConsulta() {
            document.getElementById('modalConsulta').classList.remove('active');
        }

        async function salvarConsulta(e) {
            e.preventDefault();
            const consulta = {
                cpf_paciente: document.getElementById('consultaCPFPaciente').value,
                crm_profissional: document.getElementById('consultaCRMProfissional').value,
                data: document.getElementById('consultaData').value,
                horario: document.getElementById('consultaHorario').value,
                status: document.getElementById('consultaStatus').value
            };
            try {
                let res;
                if (editandoConsultaID) {
                    res = await fetch(`${API_URL}/consulta-atualizar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: editandoConsultaID,
                            data: consulta.data,
                            horario: consulta.horario,
                            status: consulta.status,
                            crm_profissional: consulta.crm_profissional
                        })
                    });
                } else {
                    res = await fetch(`${API_URL}/consultas`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(consulta)
                    });
                }
                const data = await res.json();
                if (data.success) {
                    showAlert(data.message, 'success');
                    closeModalConsulta();
                    loadConsultas();
                    loadDashboard();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                handleError(error);
            }
        }

        async function editarConsulta(index) {
            const consulta = consultasList[index];
            editandoConsultaID = consulta.id;
            document.getElementById('modalConsultaTitle').textContent = 'Editar Consulta';
            document.getElementById('consultaCPFPaciente').value = consulta.cpf_paciente;
            document.getElementById('consultaCRMProfissional').value = consulta.crm_profissional;
            document.getElementById('consultaData').value = consulta.data;
            document.getElementById('consultaHorario').value = consulta.horario;
            document.getElementById('consultaStatus').value = consulta.status;
            document.getElementById('modalConsulta').classList.add('active');
        }

        async function deletarConsulta(index) {
            if (!confirm('Tem certeza que deseja deletar esta consulta?')) return;
            const consulta = consultasList[index];
            try {
                const res = await fetch(`${API_URL}/consulta-deletar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: consulta.id })
                });
                const data = await res.json();
                if (data.success) {
                    showAlert('Consulta deletada', 'success');
                    loadConsultas();
                    loadDashboard();
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                handleError(error);
            }
        }

        // RELAT√ìRIOS
        async function gerarRelatorioProfissional() {
            try {
                const res = await fetch(`${API_URL}/relatorios/consultas-por-profissional`);
                const data = await res.json();

                if (data.success) {
                    let html = '<h3 style="margin-bottom: 15px;">Consultas por Profissional</h3>';
                    Object.entries(data.data).forEach(([prof, consultas]) => {
                        html += `
                            <div class="card" style="margin-bottom: 15px;">
                                <h4>${prof}</h4>
                                <table style="margin-top: 10px; width: 100%;">
                                    <thead>
                                        <tr style="background-color: var(--secondary);">
                                            <th>Data</th>
                                            <th>Hor√°rio</th>
                                            <th>Paciente</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        consultas.forEach(c => {
                            html += `
                                <tr>
                                    <td>${c.data}</td>
                                    <td>${c.horario}</td>
                                    <td>${c.paciente}</td>
                                </tr>
                            `;
                        });
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    });
                    document.getElementById('relatoriosContainer').innerHTML = html;
                }
            } catch (error) {
                handleError(error);
            }
        }

        async function gerarRelatorioConvenio() {
            try {
                const res = await fetch(`${API_URL}/relatorios/pacientes-por-convenio`);
                const data = await res.json();

                if (data.success) {
                    let html = '<h3 style="margin-bottom: 15px;">Pacientes por Conv√™nio</h3><div class="stats-row">';
                    Object.entries(data.data).forEach(([convenio, quantidade]) => {
                        html += `
                            <div class="stat-item">
                                <div class="stat-label">${convenio}</div>
                                <div class="stat-value">${quantidade}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('relatoriosContainer').innerHTML = html;
                }
            } catch (error) {
                handleError(error);
            }
        }

        async function exportarCSV(tipo) {
            try {
                const res = await fetch(`${API_URL}/relatorios/exportar-csv`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tipo })
                });
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${tipo}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showAlert(`Arquivo ${tipo}.csv baixado com sucesso!`, 'success');
            } catch (error) {
                handleError(error);
            }
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                alert('At√© logo! üëã');
                location.reload();
            }
        }

        loadDashboard();
    </script>
</body>
</html>
